version: '3.8'

services:
  # ðŸ—„ï¸ DATABASE
  postgres:
    image: mintreestdmu/interview-postgres:latest
    container_name: interview-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-123456}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - interview-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ðŸ”´ REDIS
  redis:
    image: mintreestdmu/interview-redis:latest
    container_name: interview-redis
    ports:
      - "6379:6379"
    networks:
      - interview-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ðŸ”§ CONFIG SERVER
  config-service:
    image: mintreestdmu/interview-config-service:latest
    container_name: interview-config-service
    ports:
      - "${CONFIG_SERVICE_PORT:-8888}:8888"
    environment:
      SPRING_PROFILES_ACTIVE: native
      CONFIG_SERVER_URI: ${CONFIG_SERVER_URI:-http://config-service:8888}
    networks:
      - interview-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ðŸ” DISCOVERY SERVER
  discovery-service:
    image: mintreestdmu/interview-discovery-service:latest
    container_name: interview-discovery-service
    ports:
      - "${DISCOVERY_SERVICE_PORT:-8761}:8761"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      EUREKA_DEFAULT_ZONE: ${EUREKA_DEFAULT_ZONE:-http://discovery-service:8761/eureka/}
    networks:
      - interview-network
    depends_on:
      config-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ðŸŒ API GATEWAY
  gateway-service:
    image: mintreestdmu/interview-gateway-service:latest
    container_name: interview-gateway-service
    ports:
      - "${GATEWAY_SERVICE_PORT:-8080}:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      JWT_SECRET: ${JWT_SECRET}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
    networks:
      - interview-network
    depends_on:
      discovery-service:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ðŸ” AUTH SERVICE
  auth-service:
    image: mintreestdmu/interview-auth-service:latest
    container_name: interview-auth-service
    ports:
      - "${AUTH_SERVICE_PORT:-8081}:8081"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST:-postgres}:${POSTGRES_PORT:-5432}/${AUTH_DB:-authdb}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-123456}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_MINUTES: ${JWT_ACCESS_MINUTES:-30}
      JWT_REFRESH_DAYS: ${JWT_REFRESH_DAYS:-7}
      JWT_ISSUER: ${JWT_ISSUER:-http://auth-service:8081}
      MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
    networks:
      - interview-network
    depends_on:
      postgres:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ðŸ‘¤ USER SERVICE
  user-service:
    image: mintreestdmu/interview-user-service:latest
    container_name: interview-user-service
    ports:
      - "${USER_SERVICE_PORT:-8082}:8082"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST:-postgres}:${POSTGRES_PORT:-5432}/${USER_DB:-userdb}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-123456}
      JWT_SECRET: ${JWT_SECRET}
    networks:
      - interview-network
    depends_on:
      postgres:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ðŸŽ¯ CAREER SERVICE
  career-service:
    image: mintreestdmu/interview-career-service:latest
    container_name: interview-career-service
    ports:
      - "${CAREER_SERVICE_PORT:-8084}:8084"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST:-postgres}:${POSTGRES_PORT:-5432}/${CAREER_DB:-careerdb}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-123456}
      JWT_SECRET: ${JWT_SECRET}
    networks:
      - interview-network
    depends_on:
      postgres:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # â“ QUESTION SERVICE
  question-service:
    image: mintreestdmu/interview-question-service:latest
    container_name: interview-question-service
    ports:
      - "${QUESTION_SERVICE_PORT:-8085}:8085"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST:-postgres}:${POSTGRES_PORT:-5432}/${QUESTION_DB:-questiondb}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-123456}
      JWT_SECRET: ${JWT_SECRET}
    networks:
      - interview-network
    depends_on:
      postgres:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ðŸ“ EXAM SERVICE
  exam-service:
    image: mintreestdmu/interview-exam-service:latest
    container_name: interview-exam-service
    ports:
      - "${EXAM_SERVICE_PORT:-8086}:8086"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST:-postgres}:${POSTGRES_PORT:-5432}/${EXAM_DB:-examdb}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-123456}
      JWT_SECRET: ${JWT_SECRET}
    networks:
      - interview-network
    depends_on:
      postgres:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ðŸ“° NEWS SERVICE
  news-service:
    image: mintreestdmu/interview-news-service:latest
    container_name: interview-news-service
    ports:
      - "${NEWS_SERVICE_PORT:-8087}:8087"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST:-postgres}:${POSTGRES_PORT:-5432}/${NEWS_DB:-newsdb}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-123456}
      JWT_SECRET: ${JWT_SECRET}
    networks:
      - interview-network
    depends_on:
      postgres:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ðŸ¤– NLP SERVICE
  nlp-service:
    image: mintreestdmu/interview-nlp-service:latest
    container_name: interview-nlp-service
    ports:
      - "${NLP_SERVICE_PORT:-8088}:8088"
    environment:
      JWT_SECRET: ${JWT_SECRET}
      QUESTION_SERVICE_URL: http://question-service:8085
      EXAM_SERVICE_URL: http://exam-service:8086
    networks:
      - interview-network
    depends_on:
      - discovery-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    driver: local

networks:
  interview-network:
    driver: bridge
